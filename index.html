<!DOCTYPE html>
<html>

<head>
    <title>Speech to Text</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/kuroshiro.min.js"></script>
    <script src="js/kuroshiro-analyzer-kuromoji.min.js"></script>
</head>

<body>
    <h1>Speech to Text</h1>
    <label for="language">Language:</label>
    <select id="language">
        <option value="English">English</option>
        <option value="Español">Español</option>
        <option value="Français">Français</option>
        <option value="Deutsch">Deutsch</option>
        <option value="Italiano">Italiano</option>
        <option value="日本語">日本語</option>
    </select>
    <button id="startRecBtn" onclick="startRecognition()">Start</button>
    <button id="stopRecBtn" disabled onclick="stopRecognition()" ">Stop</button>
	<button onclick=" clearTextArea()">Clear</button>
    <input type="checkbox" id="tts-checkbox">
    <label for="tts-checkbox">Enable Text-to-Speech</label>

    <button id="playBtn" disabled>Play</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="resumeBtn" disabled>Resume</button>
    <button id="stopBtn" disabled>Stop</button>
    <label for="language">Translation Language:</label>
    <select id="trtgtlang" aria-label="Language Translate Widget">
        <option value="">Select Language</option>
        <option value="en">English</option>
        <option value="ja">Japanese</option>
        <option value="af">Afrikaans</option>
        <option value="sq">Albanian</option>
        <option value="am">Amharic</option>
        <option value="ar">Arabic</option>
        <option value="hy">Armenian</option>
        <option value="as">Assamese</option>
        <option value="ay">Aymara</option>
        <option value="az">Azerbaijani</option>
        <option value="bm">Bambara</option>
        <option value="eu">Basque</option>
        <option value="be">Belarusian</option>
        <option value="bn">Bengali</option>
        <option value="bho">Bhojpuri</option>
        <option value="bs">Bosnian</option>
        <option value="bg">Bulgarian</option>
        <option value="my">Burmese</option>
        <option value="ca">Catalan</option>
        <option value="ceb">Cebuano</option>
        <option value="ny">Chichewa</option>
        <option value="zh-CN">Chinese (Simplified)</option>
        <option value="zh-TW">Chinese (Traditional)</option>
        <option value="co">Corsican</option>
        <option value="hr">Croatian</option>
        <option value="cs">Czech</option>
        <option value="da">Danish</option>
        <option value="dv">Dhivehi</option>
        <option value="doi">Dogri</option>
        <option value="nl">Dutch</option>
        <option value="eo">Esperanto</option>
        <option value="et">Estonian</option>
        <option value="ee">Ewe</option>
        <option value="tl">Filipino</option>
        <option value="fi">Finnish</option>
        <option value="fr">French</option>
        <option value="fy">Frisian</option>
        <option value="gl">Galician</option>
        <option value="ka">Georgian</option>
        <option value="de">German</option>
        <option value="el">Greek</option>
        <option value="gn">Guarani</option>
        <option value="gu">Gujarati</option>
        <option value="ht">Haitian Creole</option>
        <option value="ha">Hausa</option>
        <option value="haw">Hawaiian</option>
        <option value="iw">Hebrew</option>
        <option value="hi">Hindi</option>
        <option value="hmn">Hmong</option>
        <option value="hu">Hungarian</option>
        <option value="is">Icelandic</option>
        <option value="ig">Igbo</option>
        <option value="ilo">Ilocano</option>
        <option value="id">Indonesian</option>
        <option value="ga">Irish Gaelic</option>
        <option value="it">Italian</option>
        <option value="jw">Javanese</option>
        <option value="kn">Kannada</option>
        <option value="kk">Kazakh</option>
        <option value="km">Khmer</option>
        <option value="rw">Kinyarwanda</option>
        <option value="gom">Konkani</option>
        <option value="ko">Korean</option>
        <option value="kri">Krio</option>
        <option value="ku">Kurdish (Kurmanji)</option>
        <option value="ckb">Kurdish (Sorani)</option>
        <option value="ky">Kyrgyz</option>
        <option value="lo">Lao</option>
        <option value="la">Latin</option>
        <option value="lv">Latvian</option>
        <option value="ln">Lingala</option>
        <option value="lt">Lithuanian</option>
        <option value="lg">Luganda</option>
        <option value="lb">Luxembourgish</option>
        <option value="mk">Macedonian</option>
        <option value="mai">Maithili</option>
        <option value="mg">Malagasy</option>
        <option value="ms">Malay</option>
        <option value="ml">Malayalam</option>
        <option value="mt">Maltese</option>
        <option value="mi">Maori</option>
        <option value="mr">Marathi</option>
        <option value="mni-Mtei">Meiteilon (Manipuri)</option>
        <option value="lus">Mizo</option>
        <option value="mn">Mongolian</option>
        <option value="ne">Nepali</option>
        <option value="no">Norwegian</option>
        <option value="or">Odia (Oriya)</option>
        <option value="om">Oromo</option>
        <option value="ps">Pashto</option>
        <option value="fa">Persian</option>
        <option value="pl">Polish</option>
        <option value="pt">Portuguese</option>
        <option value="pa">Punjabi</option>
        <option value="qu">Quechua</option>
        <option value="ro">Romanian</option>
        <option value="ru">Russian</option>
        <option value="sm">Samoan</option>
        <option value="sa">Sanskrit</option>
        <option value="gd">Scots Gaelic</option>
        <option value="nso">Sepedi</option>
        <option value="sr">Serbian</option>
        <option value="st">Sesotho</option>
        <option value="sn">Shona</option>
        <option value="sd">Sindhi</option>
        <option value="si">Sinhala</option>
        <option value="sk">Slovak</option>
        <option value="sl">Slovenian</option>
        <option value="so">Somali</option>
        <option value="es">Spanish</option>
        <option value="su">Sundanese</option>
        <option value="sw">Swahili</option>
        <option value="sv">Swedish</option>
        <option value="tg">Tajik</option>
        <option value="ta">Tamil</option>
        <option value="tt">Tatar</option>
        <option value="te">Telugu</option>
        <option value="th">Thai</option>
        <option value="ti">Tigrinya</option>
        <option value="ts">Tsonga</option>
        <option value="tr">Turkish</option>
        <option value="tk">Turkmen</option>
        <option value="ak">Twi</option>
        <option value="uk">Ukrainian</option>
        <option value="ur">Urdu</option>
        <option value="ug">Uyghur</option>
        <option value="uz">Uzbek</option>
        <option value="vi">Vietnamese</option>
        <option value="cy">Welsh</option>
        <option value="xh">Xhosa</option>
        <option value="yi">Yiddish</option>
        <option value="yo">Yoruba</option>
        <option value="zu">Zulu</option>
    </select>
    <input id="translateBtn" type="button" value="Translate" />

    <br>

    <div class="row">
        <div class="column50">
            <textarea id="transcript"></textarea>
            <br>
            <div id="output"></div>
            <div id="example"></div>
        </div>
        <div class="column50" id="gt">
            <div id="translatetxt"></div>
            <textarea id="resultText"></textarea>
            <div id="furigana"></div>
        </div>
    </div>
    <!--
	<textarea id="transcript" cols="80" rows="80"></textarea>
	-->
    <script>
        // Initialize the SpeechRecognition API
        const recognition = new webkitSpeechRecognition();
        const transcriptTextarea = document.getElementById('transcript');
        const ttsCheckbox = document.getElementById("tts-checkbox");
        let isTtsEnabled = false;

        let ttsUtterance = null;
        let ttsPaused = false;


        recognition.continuous = true;
        recognition.interimResults = false;

        const synth = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance();

        const startRecBtn = document.getElementById('startRecBtn');
        const stopRecBtn = document.getElementById('stopRecBtn');

        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const translateBtn = document.getElementById('translateBtn');

        let deflang = 'en';
        const languageSelect = document.getElementById("language");

        recognition.lang = languageSelect.value;

        languageSelect.addEventListener("change", () => {
            recognition.lang = languageSelect.value;
            utterance.lang = languageSelect.value;
            deflang = languages[document.getElementById("language").value].slice(0, 2);
            //        console.log(deflang);
        });

        ttsCheckbox.addEventListener("change", () => {
            isTtsEnabled = ttsCheckbox.checked;
            playBtn.disabled = !ttsCheckbox.checked;

        });


        translateBtn.addEventListener('click', () => {
            translate();
        });



        playBtn.addEventListener('click', () => {
            speakText(transcriptTextarea.value.replace(/(?:\r\n|\r|\n|\/|:)/g, '...'));
        });

        // pause the TTS when the pause button is clicked
        pauseBtn.addEventListener('click', () => {
            synth.pause();
        });

        // resume the TTS when the resume button is clicked
        resumeBtn.addEventListener('click', () => {
            synth.resume();
        });

        // stop the TTS when the stop button is clicked
        stopBtn.addEventListener('click', () => {
            synth.cancel();
        });




        // Define the language options
        const languages = {
            "English": "en-US",
            "Español": "es-ES",
            "Français": "fr-FR",
            "Deutsch": "de-DE",
            "Italiano": "it-IT",
            "日本語": "ja-JP"
        };

        // Define the text-to-speech voice options
        const voices = {
            "English": "Alex",
            "Español": "Monica",
            "Français": "Thomas",
            "Deutsch": "Anna",
            "Italiano": "Alice",
            "日本語": "Kyoko"
        };

        function loadScript() {
            const kuroshirominscript = document.createElement("script");

            kuroshirominscript.src = "https://indojapcorp.github.io/tts/js/kuroshiro.min.js";
            kuroshirominscript.async = true;

            const kuroshiroanalminscript = document.createElement("script");
            kuroshiroanalminscript.src = "https://indojapcorp.github.io/tts/js/kuroshiro-analyzer-kuromoji.min.js";
            kuroshiroanalminscript.async = true;

            // const container = document.createElement("div");
            // container.appendChild(kuroshirominscript);
            // container.appendChild(kuroshiroanalminscript);
            // Append the container to the head or body of your HTML document
            document.head.appendChild(kuroshirominscript);
            document.head.appendChild(kuroshiroanalminscript);
        }


        function speakText(text) {
            utterance.text = text;

            var words = text.split(" ");
            var currentWord = 0;
            utterance.voice = speechSynthesis.getVoices()
                .find(voice => voice.name === voices[document.getElementById("language").value]);

            var words = text.split(" ");
            var currentWord = 0;
            var startOffset = 0;
            var endOffset = 0;
            var intervalId = null;

            // add event listeners to utterance
            utterance.onstart = () => {
                playBtn.disabled = true;
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
                stopBtn.disabled = false;
            };

            utterance.onpause = () => {
                playBtn.disabled = true;
                pauseBtn.disabled = true;
                resumeBtn.disabled = false;
                stopBtn.disabled = false;
            };

            utterance.onresume = () => {
                playBtn.disabled = true;
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
                stopBtn.disabled = false;
            };

            utterance.onend = () => {
                playBtn.disabled = false;
                pauseBtn.disabled = true;
                resumeBtn.disabled = true;
                stopBtn.disabled = true;
                window.getSelection().empty();
            };

            // speak the text
            synth.speak(utterance);
        }



        function clearTextArea() {
            transcriptTextarea.value = '';
        }

        // Define the function to start speech recognition
        function startRecognition() {
            recognition.lang = languages[document.getElementById("language").value];
            recognition.start();
            startRecBtn.disabled = true;
            stopRecBtn.disabled = false;
        }

        // Define the function to stop speech recognition
        function stopRecognition() {
            recognition.stop();
            startRecBtn.disabled = false;
            stopRecBtn.disabled = true;
            if (window.getSelection) {
                if (window.getSelection().empty) {  // Chrome
                    window.getSelection().empty();
                } else if (window.getSelection().removeAllRanges) {  // Firefox
                    window.getSelection().removeAllRanges();
                }
            } else if (document.selection) {  // IE?
                document.selection.empty();
            }
        }

        recognition.onresult = function (event) {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    transcript += event.results[i][0].transcript + '\n';
                } else {
                    transcript += event.results[i][0].transcript;
                }
            }
            transcriptTextarea.value += transcript;
        }

        recognition.onerror = function (event) {
            console.error(event.error);
        }

        // Add event listeners for text-to-speech
        document.getElementById("transcript").addEventListener("mouseup", e => {
            const selectedText = window.getSelection().toString();
            const pattern = /(?:\r\n|\r|\n|\/|:)/;
            if (pattern.test(selectedText)) {
                console.log('Contains new line');
                return;
            }

            if (deflang == 'en') {
                getDefinitionExample();
            }

            if (isTtsEnabled && selectedText !== "") {
                speakText(selectedText);
            }
        });

        function getDefinition() {
            var selectedText = window.getSelection().toString().trim();
            const pattern = /(?:\r\n|\r|\n|\/|:)/;
            if (pattern.test(selectedText)) {
                console.log('Contains new line');
                return;
            }

            if (selectedText !== "") {
                var apiUrl = 'https://api.dictionaryapi.dev/api/v2/entries/en/' + selectedText;
                fetch(apiUrl)
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (data) {
                        var definition = data[0].meanings[0].definitions[0].definition;
                        document.getElementById("output").innerHTML = '<strong>Definition:</strong> ' + definition;
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        document.getElementById("output").innerHTML = '<strong>Definition:</strong> Not found';
                    });
            }
        }

        function getDefinitionExample() {

            var selectedText = window.getSelection().toString().trim();
            const pattern = /(?:\r\n|\r|\n|\/|:)/;
            if (pattern.test(selectedText)) {
                console.log('Contains new line');
                return;
            }

            if (selectedText !== "") {
                //var apiUrl = 'https://api.dictionaryapi.dev/api/v2/entries/en/' + selectedText;
                var apiUrl = 'https://api.dictionaryapi.dev/api/v2/entries/' + deflang + '/' + selectedText;
                fetch(apiUrl)
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (data) {
                        var definition = data[0].meanings[0].definitions[0].definition;
                        var example = data[0].meanings[0].definitions[0].example;
                        document.getElementById("output").innerHTML = '<strong>Definition:</strong> ' + definition;
                        document.getElementById("example").innerHTML = '<strong>Example:</strong> ' + example;
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        document.getElementById("output").innerHTML = '<strong>Definition:</strong> Not found';
                        document.getElementById("example").innerHTML = '';
                    });
            }
        }

        function getJishoOrgDefinitionExample() {
            var selectedText = window.getSelection().toString().trim();
            const pattern = /(?:\r\n|\r|\n|\/|:)/;
            if (pattern.test(selectedText)) {
                console.log('Contains new line');
                return;
            }

            if (selectedText !== "") {
                var apiUrl = 'https://jisho.org/api/v1/search/words?keyword=' + selectedText;
                fetch(apiUrl)
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (data) {
                        var definition = data.data[0].senses[0].english_definitions.join(", ");
                        var example = data.data[0].senses[0].examples[0].english_sentence;
                        document.getElementById("output").innerHTML = '<strong>Definition:</strong> ' + definition;
                        document.getElementById("example").innerHTML = '<strong>Example:</strong> ' + example;
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        document.getElementById("output").innerHTML = '<strong>Definition:</strong> Not found';
                        document.getElementById("example").innerHTML = '';
                    });
            }
        }

        function getDefinitionFromCSV() {
            var selectedText = window.getSelection().toString().trim();
            const pattern = /(?:\r\n|\r|\n|\/|:)/;
            if (pattern.test(selectedText)) {
                console.log('Contains new line');
                return;
            }

            if (selectedText !== "") {
                var request = new XMLHttpRequest();
                var url = "data/GRE_1300.csv";
                request.open("GET", url);
                request.onload = function () {
                    if (request.status === 200) {
                        var csvData = request.responseText;
                        var lines = csvData.split("\n");
                        var headers = lines[0].split(",");
                        var wordIndex = headers.indexOf("word");
                        var definitionIndex = headers.indexOf("definition");
                        var exampleIndex = headers.indexOf("example");
                        for (var i = 1; i < lines.length; i++) {
                            var values = lines[i].split(",");
                            var word = values[wordIndex];
                            var definition = values[definitionIndex];
                            var example = values[exampleIndex];
                            if (word === selectedText) {
                                var displayText = "<p><strong>" + word + "</strong>: " + definition + "</p><p>Example: " + example + "</p>";
                                //document.getElementById("definition").innerHTML = displayText;
                                document.getElementById("output").innerHTML = '<strong>Definition:</strong> ' + definition;
                                document.getElementById("example").innerHTML = '<strong>Example:</strong> ' + example;

                                break;
                            }
                        }
                    } else {
                        console.log("Error: " + request.statusText);
                    }
                };
                request.send();
            }
        }

        function translate() {

            var sourceText = $('textarea#transcript').val();
            var sourceLang = deflang;
            var targetLang = $('#trtgtlang').val();
            //var targetLang = 'ja';
            var finalstr = "";

            var url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl=" + sourceLang + "&tl=" + targetLang + "&dt=t&q=" + encodeURI(sourceText);
            //  console.log(url);
            $.getJSON(url, function (data) {
                //$('textarea#resultText').val(data[0][0][0]);

                $.each(data[0], function (index, val) {
                    finalstr += val[0];
                });

                //  console.log(finalstr);
                $('textarea#resultText').val(finalstr);


                if (sourceLang == 'ja' || targetLang == 'ja') {

                    if (targetLang == 'ja') {
                        sourceText = finalstr;
                    }

                    var kuroshiro = new Kuroshiro();//https://github.com/indojapcorp/tts/tree/main/js/dict
                    //https://indojapcorp.github.io/tts/js/dict
                    //kuroshiro.init(new KuromojiAnalyzer({ dictPath: "https://indojapcorp.github.io/tts/js/dict" }))
                    kuroshiro.init(new KuromojiAnalyzer({ dictPath: "js/dict" }))
                    //kuroshiro.init(new KuromojiAnalyzer({ dictPath: "https://github.com/indojapcorp/tts/tree/main/js/dict" }))
                        .then(function () {
                            return kuroshiro.convert(sourceText, { mode: "furigana", to: "romaji" });
                            return kuroshiro.convert(sourceText, { mode: "spaced", to: "romaji" });
                        })
                        .then(function (result) {
                            document.getElementById("furigana").innerHTML = '<strong>Furigana:</strong> ' + result;
                        });
                }

            });


        }
    </script>
</body>

</html>